---
title: PHP正则表达式
date: '2013-07-06'
description:
categories: Tech
tags:[PHP,Regex,PCRE]
---
###占有字符和零宽度（Anchors）###

正则表达式匹配过程中，如果子表达式匹配到的是字符内容，而非位置，并被保存到最终的匹配结果中，那么就认为这个子表达式是占有字符的；如果子表达式匹配的仅仅是位置，或者匹配的内容并不保存到最终的匹配结果中，那么就认为这个子表达式是零宽度的。

占有字符还是零宽度，是针对匹配的内容是否保存到最终的匹配结果中而言的。

占有字符是互斥的，零宽度是非互斥的。也就是一个字符，同一时间只能由一个子表达式匹配，而一个位置，却可以同时由多个零宽度的子表达式匹配。

###贪婪匹配与懒惰匹配（Greedy and Lazy Repetition）###

标准量词修饰的子表达式，在可匹配可不匹配的情况下，总会先尝试进行匹配，称这种方式为匹配优先（尽可能的多匹配），或者贪婪模式。`“{m}”`、`“{m,n}”`、`“{m,}”`、`“?”`、`“*”`和`“+”`都是匹配优先的。在以上量词后面加`“?”`则会优先忽略匹配，即懒惰（非贪婪）匹配。

###分组（Grouping）与后向引用（Backreferences）###

**分组**

我们知道怎么重复单个字符（直接在字符后面加上限定符就行了）；但如果想要重复多个字符又该怎么办？你可以用小括号来指定子表达式(也叫做分组)，然后你就可以指定这个子表达式的重复次数了，你也可以对子表达式进行其它一些操作。

分组又分为捕获组和非捕获组：

- 捕获组就是把正则表达式中子表达式匹配的内容，保存到内存中以数字编号或手动命名的组里，以供后面引用。捕获组又分为普通捕获组和命名捕获组：

	表达式|说明
	-|-
	(Expression)|普通捕获组，将子表达式Expression匹配的内容保存到以数字编号的组里
	(?\<name\> Expression)|命名捕获组，将子表达式Expression匹配的内容保存到以name命名的组里

- 一些表达式中，不得不使用( )，但又不需要保存( )中子表达式匹配的内容，这时可以用非捕获组来抵消使用( )带来的副作用。

	表达式|说明
	-|-
	(?:Expression)|进行子表达式Expression的匹配，并将匹配内容保存到最终的整个表达式的区配结果中，但Expression匹配的内容不单独保存到一个组内

**后向引用**

捕获组匹配的内容，可以在正则表达式的外部程序中进行引用，也可以在表达式中进行引用，表达式中引用的方式就是后向引用。

表达式|说明
-|-
\1，\2|对序号为1和2的捕获组的后向引用
\k\<name\>|对命名为name的捕获组的后向引用

###环视（Lookaround）###

环视只进行子表达式的匹配，匹配内容不计入最终的匹配结果，是零宽度的。

环视按照方向划分有顺序和逆序两种，按照是否匹配有肯定和否定两种，组合起来就有四种环视。环视相当于对所在位置加了一个附加条件。

表达式|说明
-|-
(?<=Expression)|逆序肯定环视，表示所在位置左侧能够匹配Expression
(?<!Expression)|逆序否定环视，表示所在位置左侧不能匹配Expression
(?=Expression)|顺序肯定环视，表示所在位置右侧能够匹配Expression
(?!Expression)|顺序否定环视，表示所在位置右侧不能匹配Expression

*举例：*

`“(?<=Windows )\d+”`在匹配`“Windows 2003”`时，匹配成功，匹配结果为`“2003”`。我们知道`“\d+”`表示匹配一个以上的数字，而`“(?<=Windows )”`相当于一个附加条件，表示所在位置左侧必须为`“Windows ”`，它所匹配的内容并不计入匹配结果。同样的正则在匹配`“Office 2003”`时，匹配失败，因为这里任意一串数字子串的左侧都不是`“Windows ”`。

`“(?!1)\d+”`在匹配`“123”`时，匹配成功，匹配的结果为`“23”`。`“\d+”`匹配一个以上数字，但是附加条件`“(?!1)”`要求所在位置右侧不能是`“1”`，所以匹配成功的位置是`“2”`前面的位置。

###PHP正则（PCRE）###

PHP的正则表达式主要是基于Perl的PCRE实现和基于POSIX的EREG实现。由于EREG在PHP 5.3.0及以后版本已经弃用，所以这里只讨论PCRE正则库。

**分隔符（delimiters）**

当使用 PCRE 函数的时候，模式需要由分隔符闭合包裹。分隔符可以使任意非字母数字、非反斜线、非空白字符。

经常使用的分隔符是正斜线(/)、hash符号(#) 以及取反符号(~)。

**转义序列（escape）**

PHP正则里面要匹配一个反斜线， 模式中必须写为 `“\\\\”`。（首先作为字符串，反斜线会进行转义，成为`/\\/`，最后正则转义一次，得到`/\/`）

**修饰符（modifiers）**

内部修饰符：(?修饰符)

- `'/(?i)sss/'` #(?i)忽略大小写敏感
- `'/(?Ui)sss/'` #(?Ui)去贪婪且忽略大小写敏感,或者在量词后面加'?'号实现贪婪逆转,如'*?','+?'
- `'/(?s)sss/'` #(?s)使得.可以匹配换行符

外部修饰符：

修饰符|表示含义
-|-
i(PCRE_CASELESS)|忽略字符敏感
m(PCRE_MULTILINE)|多行模式
s(PCRE_DOTALL)|.号匹配换行
u(PCRE_UTF8)|匹配utf8字符(unicode)(与perl不兼容)
U(PCRE_UNGREEDY)|去贪婪(与perl不兼容)
e(PREG_REPLACE_EVAL)|仅在perg_replace时生效，当有e时，会对replace后的字符进行eval（不建议使用e）

**子组（subpatterns）**

表达式|说明
-|-
(pattern)|普通捕获组
(?P\<name\>pattern)|命名捕获组，PHP 4.3.3及以上
(?\<name\>pattern)|命名捕获组，PHP 5.2.2及以上
(?'name'pattern)|命名捕获组，PHP 5.2.2及以上
(?:pattern)|非捕获组

- `'/(sum) min/'` #捕获一个子组(子组序号最多99个)
- `'/(?<total>sum) min/'` #命名一个子组
- `'/(?:sum) min/'` #不捕获子组(捕获子组和非捕获子组最多200个)
- `'/(?|(sum)|(total)) min/'` #不捕获本子组,但在有'|'时,(sum)与(total)反向引用都占1.如果使用'?:',"sum"与"total"会分别占用\1和\2
- `'/(?Ui:sum) min/'` #?与:之间可以加修饰符.等价于'/(?:(?Ui)sum) min/'

**后向引用**

preg_match

类型|表达式
-|-
普通捕获组|\1、\g1、\g{1}（PHP 5.2.2及以上\g 转义序列可以用于子模式的绝对和相对引用）
命名捕获组|\k\<name\> 或 \k'name'（PHP 5.2.2及以上）
命名捕获组|\k{name} 和 \g{name}（PHP 5.2.4及以上）

preg_replace

类型|表达式
-|-
普通捕获组|\1、$1、${1}

**非回溯子组**

(?>pattern)

这种括号对模式的一部分提供了”锁定”，当它包含一个匹配之后， 会阻止未来模式失败后对它内部的后向回溯。后向回溯在这里失效， 其他工作照常进行。

- `(\d+foo)` #在匹配123bar时,第一次失败,回溯匹配23bar,又失败,再回溯匹配3bar,再回溯.
- `(?>\d+foo)` ?>分组匹配失败后,不会再回溯.

**条件子组**

`(?(condition)yes-pattern)`  
`(?(condition)yes-pattern|no-pattern)`

如果条件满足，使用 yes-pattern，其他情况使用 no-pattern(如果指定了)。 如果有超过 2 个的可选子组，会产生给一个编译期错误。

**递归子组**

php5.4之后,会支持递归子组。

`(?R)`  #这个?R反向引用正则本身  
`(?num)`  #这个?num反向引用第num个子分组,而非子分组所匹配的字符\num

比如:

	#\((?R)*\)#             就可匹配 "((()))"括号对
	#(blue|red) (?1)#       就可匹配 "blue red"括号对
	#(blue|red) (\1)#       只能匹配 "blue blue","red red"

参考：  
1. [正则表达式30分钟入门教程](http://deerchao.net/tutorials/regex/regex.htm)  
2. [正则表达式学习参考](http://blog.csdn.net/lxcnn/article/details/4268033)  
3. [Regular Expression Quick Start](http://www.regular-expressions.info/quickstart.html)  
4. [PCRE 正则语法](http://www.php.net/manual/zh/reference.pcre.pattern.syntax.php)  
5. [php中的正则](http://hilojack.sinaapp.com/?p=1348)  

